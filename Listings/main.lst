C51 COMPILER V9.59.0.0   MAIN                                                              12/30/2020 22:25:38 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /*-------------------------------------------Í·ÎÄ¼þ-------------------------------------------*/
   2          #include <STC8.H>
   3          #include "intrins.h"            //µ¥Æ¬»úCÓïÑÔÊ¹ÓÃ»ã±àÖ¸ÁîµÄÍ·ÎÄ¼þ¡£
   4          /*-------------------------------------------ºê¶¨Òå-------------------------------------------*/
   5          typedef unsigned char u8;       //ÎÞ·ûºÅµÄ 8Î»±äÁ¿¡£
   6          typedef unsigned int  u16;      //ÎÞ·ûºÅµÄ16Î»±äÁ¿¡£
   7          typedef unsigned long u32;      //ÎÞ·ûºÅµÄ32Î»±äÁ¿¡£
   8          /*-----------------------------------------BOOT½Å¶¨Òå-----------------------------------------*/
   9          #define BOOT_PIN                P00     //BOOT½ÅÉèÖÃÎªP0.0½Å¡£
  10          #define BOOT_RUN_APP    0       //BOOT½ÅÎªµÍµçÆ½µÄÊ±ºòÔËÐÐAPP¡£
  11          /*------------------------------------------¹¦ÄÜ¶¨Òå------------------------------------------*/
  12          sfr                     IAP_TPS                 =0xf5;  //EEPROM²Á³ýµÈ´ýÊ±¼ä¿ØÖÆ¼Ä´æÆ÷
  13          u8      code    INIT_MASK[6]    ={0xff,0xff,0xff,0xff,0xff,0xff};//³õÊ¼»¯ÑÚÂë£¬¶ÔÓÚFLASH¶øÑÔ¾ÍÊÇ0xFF¡£
  14          void    (* jmp_app)(void);                      //Ìø×ªº¯Êý¡£
  15          #define BOOT_STATUS                     0xFE00  //FE00          £ºBootLoaderÇø×´Ì¬
  16          #define BOOT_JMP_ADDR           0xFE01  //FE01~FE02     £ºBootLoaderµÄÌø×ªµØÖ·
  17          
  18          #define APP_START                       0xFE03  //FE03          £ºAPPÇøÆðÊ¼µØÖ·
  19          #define APP_MAX                         5               //APPÇøÕ¼ÓÃ¿Õ¼äÎª6×Ö½Ú
  20          #define APP_STATUS                      0xFE03  //FE03          £ºAPPÇø×´Ì¬
  21          #define APP_SIZE                        0xFE04  //FE04~FE05     £ºAPPÇø´óÐ¡
  22          #define APP_JMP_ADDR            0xFE06  //FE06~FE07     £ºAPPµØÖ·
  23          
  24          #define DATA_MAX                        124                             //APPÇøµÄ×î´óÖµ£¬µ¥Î»ÎªÉÈÇøÊý¡£Ò»ÉÈÇøÎª512×Ö½Ú¡£
  25          #define FLASH_SIZE                      (DATA_MAX*512)  //APPÇøµÄ×î´óÖµ£¬µ¥Î»Îª×Ö½Ú¡£
  26          
  27          #define read_jmp__addr          (*(unsigned int  code *)(0x0001))               //¶ÁÈ¡Õû¸ö³ÌÐòµÄÌø×ªµØÖ·¡£
  28          #define read_jmp__addr_h        (*(unsigned char code *)(0x0001))
  29          #define read_jmp__addr_l        (*(unsigned char code *)(0x0002))
  30          
  31          #define read_boot_addr          (*(unsigned int  code *)(BOOT_JMP_ADDR))//¶ÁÈ¡BootloaderµÄÌø×ªµØÖ·¡£
  32          #define read_boot_addr_h        (*(unsigned char code *)(BOOT_JMP_ADDR))
  33          #define read_boot_addr_l        (*(unsigned char code *)(BOOT_JMP_ADDR+1))
  34          
  35          #define read_app__addr          (*(unsigned int  code *)(APP_JMP_ADDR)) //¶ÁÈ¡APPµÄÌø×ªµØÖ·¡£
  36          #define read_app__addr_h        (*(unsigned char code *)(APP_JMP_ADDR)) 
  37          #define read_app__addr_l        (*(unsigned char code *)(APP_JMP_ADDR+1))
  38          
  39          #define read_app__size          (*(unsigned int  code *)(APP_SIZE))             //¶ÁÈ¡APPµÄ´óÐ¡¡£
  40          #define read_app__size_h        (*(unsigned char code *)(APP_SIZE))
  41          #define read_app__size_l        (*(unsigned char code *)(APP_SIZE+1))
  42          
  43          #define read_app__flag          (*(unsigned char code *)(APP_STATUS))   //¶ÁÈ¡APPµÄ×´Ì¬¡£
  44          #define read_boot_flag          (*(unsigned char code *)(BOOT_STATUS))  //¶ÁÈ¡BootLoaderµÄ×´Ì¬¡£
  45          //Î»¶¨Òå        [               D7              ][                      D6                      ][      D5      ][      D4      ][      D3      ][      D2      ][      D1      ][      D0      ]
  46          //APP   [       Ê¹ÄÜ±êÖ¾Î»      ][      °²×°  Íê³É±êÖ¾Î»                ][                                              Ô¤Áô                                    ]
  47          //BOOT  [       Ê¹ÄÜ±êÖ¾Î»      ][      ³õÊ¼»¯Íê³É±êÖ¾Î»                ][                                              Ô¤Áô                                    ]
  48          #define BIT_ENABLE              0x80                                    //Ê¹ÄÜÎ»¡£
  49          #define SET_ENABLE              (~(u8)(BIT_ENABLE))             //Ê¹ÄÜ¸ÃÇøÓò¡£
  50          #define GET_ENABLE              ( (u8)(BIT_ENABLE))             //²éÑ¯Ê¹ÄÜÎ»¡£
  51          
  52          #define BIT_DONE                0x40                                    //Íê³ÉÎ»¡£
  53          #define SET_DONE                (~(u8)(BIT_DONE))               //¸ÃÇøÓòÍê³ÉÁËÉè¶¨¹¦ÄÜ¡£
  54          #define GET_DONE                ( (u8)(BIT_DONE))               //²éÑ¯Íê³ÉÎ»¡£
C51 COMPILER V9.59.0.0   MAIN                                                              12/30/2020 22:25:38 PAGE 2   

  55          
  56          #define PD_APP__OK              (GET_ENABLE|GET_DONE)   //ÅÐ¶ÏAPPÇøÊÇ·ñÓÐºÏ·¨µÄ³ÌÐò¡£
  57          #define APP__OK                 (0)                                             //APPÇøÊÇºÏ·¨µÄ³ÌÐò¡£
  58          /*------------------------------------------º¯Êý¶¨Òå------------------------------------------*/
  59          #if 1//´®¿Ú²¿·Ö
  60          /*-------------------------------------------------------
  61          º¯ÊýÃû£ºhard_init
  62          Ãè  Êö£ºÓ²¼þÍâÉè³õÊ¼»¯º¯Êý¡£
  63          ´´½¨Õß£ºÄÎÌØ
  64          µ÷ÓÃÀý³Ì£ºÎÞ
  65          ´´½¨ÈÕÆÚ£º2020-11-30
  66          ÐÞ¸Ä¼ÇÂ¼£º
  67          2020-12-08£ººÏ²¢ÁË´®¿ÚºÍ¶¨Ê±Æ÷µÄ³õÊ¼»¯¡£¸üÃûÎªhard_init¡£
  68          -------------------------------------------------------*/
  69          void hard_init(void){   
  70   1              SCON = 0x50;            //8Î»Êý¾Ý,¿É±ä²¨ÌØÂÊ
  71   1              AUXR = 0x40;            //¶¨Ê±Æ÷1Ê±ÖÓÎªFosc,¼´1T
  72   1              TMOD = 0x00;            //Éè¶¨¶¨Ê±Æ÷1Îª16Î»×Ô¶¯ÖØ×°·½Ê½
  73   1              TL0 = 0xC0;                     //ÉèÖÃ¶¨Ê±³õÖµ
  74   1              TH0 = 0x63;                     //20ms
  75   1              TL1 = 0xCC;                     //Éè¶¨³õÖµ
  76   1              TH1 = 0xFF;                     //Éè¶¨³õÖµ
  77   1              TF0 = 0;                        //Çå³ýTF0±êÖ¾
  78   1              TF1 = 0;                        //Çå³ýTF1±êÖ¾
  79   1              TR0 = 0;
  80   1              TR1 = 1;                        //Æô¶¯¶¨Ê±Æ÷1
  81   1              ET1 = 0;                        //½ûÖ¹¶¨Ê±Æ÷1ÖÐ¶Ï
  82   1      }
  83          /*-------------------------------------------------------
  84          º¯ÊýÃû£ºsend_data
  85          Ãè  Êö£º´®¿Ú·¢ËÍµ¥×Ö½Úº¯Êý¡£
  86          Êä  Èë£º        dat     -       Òª·¢ËÍµÄ×Ö½Ú¡£
  87          ´´½¨Õß£ºÄÎÌØ
  88          µ÷ÓÃÀý³Ì£ºÎÞ
  89          ´´½¨ÈÕÆÚ£º2020-11-30
  90          ÐÞ¸Ä¼ÇÂ¼£º
  91          -------------------------------------------------------*/
  92          void send_data(u8 dat){
  93   1          SBUF=dat;   //·¢ËÍÒ»¸öÊý¾Ý¡£
  94   1              while(!TI);     //µÈ´ýÊý¾Ý·¢Íê¡£
  95   1              TI=0;           //Çå³ý·¢ËÍ±êÖ¾Î»¡£
  96   1      }
  97          /*-------------------------------------------------------
  98          º¯ÊýÃû£ºsend_string
  99          Ãè  Êö£º´®¿Ú·¢ËÍ×Ö·û´®º¯Êý¡£
 100          Êä  Èë£º        str     -       Òª·¢ËÍµÄ×Ö·û´®¡£
 101          ´´½¨Õß£ºÄÎÌØ
 102          µ÷ÓÃÀý³Ì£ºÎÞ
 103          ´´½¨ÈÕÆÚ£º2020-11-30
 104          ÐÞ¸Ä¼ÇÂ¼£º
 105          2020-12-08£ºÓÅ»¯ÁËº¯ÊýµÄÕ¼ÓÃ¿Õ¼ä¡£
 106          -------------------------------------------------------*/
 107          void send_string(u8 code * str){
 108   1              while(*str){    //ÅÐ¶Ï×Ö·û´®ÊÇ·ñµ½Í·£¬
 109   2                      SBUF=*str++;//·¢ËÍÒ»¸öÊý¾Ý¡£
 110   2                      while(!TI);     //µÈ´ýÊý¾Ý·¢Íê¡£
 111   2                      TI=0;           //Çå³ý·¢ËÍ±êÖ¾Î»¡£
 112   2              }       
 113   1      }
 114          /*-------------------------------------------------------
 115          º¯ÊýÃû£ºsend_num
 116          Ãè  Êö£º´®¿Ú·¢ËÍ16Î»Êý¾Ýº¯Êý£¬·¢ËÍ¸ñÊ½Îª%u¡£
C51 COMPILER V9.59.0.0   MAIN                                                              12/30/2020 22:25:38 PAGE 3   

 117          Êä  Èë£º        dat     -       Òª·¢ËÍµÄÊý¾Ý¡£
 118          ´´½¨Õß£ºÄÎÌØ
 119          µ÷ÓÃÀý³Ì£ºÎÞ
 120          ´´½¨ÈÕÆÚ£º2020-12-03
 121          ÐÞ¸Ä¼ÇÂ¼£º
 122          -------------------------------------------------------*/
 123          void send_num(u16 dat){
 124   1              u8 n[5],i;
 125   1              for(i=0;i<5;i++){
 126   2                      n[i]=dat%10;
 127   2                      dat/=10;
 128   2              }
 129   1              if(n[4]){
 130   2                      send_data('0'+n[4]);
 131   2              }
 132   1              if(n[4]|n[3]){
 133   2                      send_data('0'+n[3]);
 134   2              }
 135   1              if(n[4]|n[3]|n[2]){
 136   2                      send_data('0'+n[2]);
 137   2              }
 138   1              if(n[4]|n[3]|n[2]|n[1]){
 139   2                      send_data('0'+n[1]);
 140   2              }
 141   1              send_data('0'+n[0]);
 142   1      }
 143          #endif
 144          #if 1//FLASH²Ù×÷²¿·Ö
 145          /*-------------------------------------------------------
 146          º¯ÊýÃû£ºeeprom_off
 147          Ãè  Êö£ºeeprom¹Ø±Õº¯Êý¡£
 148          ´´½¨Õß£ºÄÎÌØ
 149          µ÷ÓÃÀý³Ì£ºÎÞ
 150          ´´½¨ÈÕÆÚ£º2020-11-30
 151          ÐÞ¸Ä¼ÇÂ¼£º
 152          -------------------------------------------------------*/
 153          void eeprom_off(void){
 154   1          IAP_CONTR = 0;   //¹Ø±ÕIAP¹¦ÄÜ
 155   1          IAP_CMD   = 0;   //Çå³ýÃüÁî¼Ä´æÆ÷
 156   1          IAP_TRIG  = 0;   //Çå³ý´¥·¢¼Ä´æÆ÷
 157   1          IAP_ADDRH = 0xff;//½«µØÖ·ÉèÖÃµ½·ÇIAPÇøÓò
 158   1          IAP_ADDRL = 0xff;//½«µØÖ·ÉèÖÃµ½·ÇIAPÇøÓò
 159   1      }
 160          /*-------------------------------------------------------
 161          º¯ÊýÃû£ºeeprom_erase
 162          Ãè  Êö£ºeeprom²Á³ýº¯Êý£¬ÓÃÓÚ²Á³ýÒ»¸öÉÈÇø¡£
 163          Êä  Èë£º        addr    -       Òª²Á³ýµÄµØÖ·¡£
 164          ´´½¨Õß£ºÄÎÌØ
 165          µ÷ÓÃÀý³Ì£ºÎÞ
 166          ´´½¨ÈÕÆÚ£º2020-11-30
 167          ÐÞ¸Ä¼ÇÂ¼£º
 168          -------------------------------------------------------*/
 169          void eeprom_erase(u16 addr){
 170   1              IAP_CONTR = 0x81;               //Ê¹ÄÜIAP
 171   1              IAP_CMD   = 3;                  //ÉèÖÃIAP²Á³ýÃüÁî
 172   1              IAP_ADDRL = addr;               //ÉèÖÃIAPµÍµØÖ·
 173   1              IAP_ADDRH = addr >> 8;  //ÉèÖÃIAP¸ßµØÖ·
 174   1              IAP_TRIG  = 0x5a;               //Ð´´¥·¢ÃüÁî(0x5a)
 175   1              IAP_TRIG  = 0xa5;               //Ð´´¥·¢ÃüÁî(0xa5)
 176   1              _nop_();                                //ÉÔÉÔµÈ´ýÒ»ÏÂ
 177   1              eeprom_off();                   //¹Ø±ÕIAP¹¦ÄÜ
 178   1      }
C51 COMPILER V9.59.0.0   MAIN                                                              12/30/2020 22:25:38 PAGE 4   

 179          /*-------------------------------------------------------
 180          º¯ÊýÃû£ºeeprom_write
 181          Ãè  Êö£ºeepromµ¥×Ö½ÚÐ´º¯Êý£¬ÓÃÓÚÏòÖ¸¶¨µØÖ·Ð´Ò»¸öÊý¾Ý¡£
 182          Êä  Èë£º        addr    -       ÒªÐ´ÈëµÄµØÖ·£»
 183                          dat             -       ÒªÐ´ÈëµÄÊý¾Ý¡£
 184          ´´½¨Õß£ºÄÎÌØ
 185          µ÷ÓÃÀý³Ì£ºÎÞ
 186          ´´½¨ÈÕÆÚ£º2020-11-30
 187          ÐÞ¸Ä¼ÇÂ¼£º
 188          -------------------------------------------------------*/
 189          void eeprom_write(u16 addr,u8 dat){
 190   1              IAP_CONTR = 0x81;               //Ê¹ÄÜIAP
 191   1              IAP_CMD   = 2;                  //ÉèÖÃIAPÐ´ÃüÁî
 192   1              IAP_ADDRL = addr;               //ÉèÖÃIAPµÍµØÖ·
 193   1              IAP_ADDRH = addr >> 8;  //ÉèÖÃIAP¸ßµØÖ·
 194   1              IAP_DATA  = dat;                //Ð´IAPÊý¾Ý
 195   1              IAP_TRIG  = 0x5a;               //Ð´´¥·¢ÃüÁî(0x5a)
 196   1              IAP_TRIG  = 0xa5;               //Ð´´¥·¢ÃüÁî(0xa5)
 197   1              _nop_();                                //ÉÔÉÔµÈ´ýÒ»ÏÂ
 198   1              eeprom_off();                   //¹Ø±ÕIAP¹¦ÄÜ
 199   1      }
 200          /*-------------------------------------------------------
 201          º¯ÊýÃû£ºeeprom_write_boot_area
 202          Ãè  Êö£ºeeprom¶à×Ö½ÚÐ´ÏµÍ³Çøº¯Êý£¬ÓÃÓÚÏòÖ¸¶¨ÇøÓòÐ´¶à¸öÊý¾Ý¡£
 203          Êä  Èë£º        addr    -       ÒªÐ´ÈëµÄµØÖ·£¬±ØÐëÒªÏµÍ³ÇøÓòÄÚ£»
 204                          buf             -       ÒªÐ´ÈëµÄÊý¾Ý»º´æ£»
 205                          len             -       ÒªÐ´ÈëµÄÊý¾ÝÊýÁ¿¡£
 206          ´´½¨Õß£ºÄÎÌØ
 207          µ÷ÓÃÀý³Ì£ºÎÞ
 208          ´´½¨ÈÕÆÚ£º2020-11-30
 209          ÐÞ¸Ä¼ÇÂ¼£º
 210          2020-12-03£ºÓÅ»¯ÁË¹¦ÄÜ£¬ÏÖÔÚÖ»Îª¹Ì¶¨ÇøÓò·þÎñÒÑ¼õÐ¡Õ¼ÓÃ¿Õ¼ä£¬
 211                                  ¸ÄÃûÎªeeprom_write_boot_area¡£
 212          -------------------------------------------------------*/
 213          volatile u8 xdata eeprom_buf[512];//ÓÃÓÚÕûºÏÊý¾ÝµÄ»º´æ
 214          void eeprom_write_boot_area(u16 addr,u8 * buf,u16 len){
 215   1              u16 i,ad;
 216   1              for(i=0;i<512;i++){                             //½«ÏµÍ³ÇøÔ­±¾µÄÊý¾Ý¶Á³öÀ´£¬·Åµ½»º´æµ±ÖÐ¡£
 217   2                      eeprom_buf[i]=(*(unsigned char code *)(BOOT_STATUS+i));
 218   2              }
 219   1              eeprom_erase(BOOT_STATUS);                      //Çå³ýÏµÍ³Çø¡£
 220   1              ad=addr-BOOT_STATUS;                                    //»ñÈ¡µØÖ·µÄÆ«ÒÆÁ¿¡£
 221   1              for(i=0;i<len;i++){                             //½«Êý¾ÝÐ´Èëµ½»º´æ¡£
 222   2                      eeprom_buf[i+ad]=buf[i];
 223   2              }
 224   1              for(i=0;i<512;i++){                             //½«»º´æÐ´»Øµ½µ¥Æ¬»ú¡£
 225   2                      eeprom_write(BOOT_STATUS+i,eeprom_buf[i]);
 226   2              }
 227   1      }
 228          #endif
 229          
 230          volatile u16 data_count=0,proj_count=0;//°üÄÚÊý¾Ý¼ÆÊýÆ÷ºÍ×ÜÊý¾Ý¼ÆÊý±äÁ¿¡£
 231          /*-------------------------------------------------------
 232          º¯ÊýÃû£ºdata_save
 233          Ãè  Êö£ºÊý¾Ý±£´æº¯Êý£¬ÓÃÓÚ±£´æ´Ó´®¿Ú½ÓÊÕµ½µÄÊý¾Ý¡£
 234          ´´½¨Õß£ºÄÎÌØ
 235          µ÷ÓÃÀý³Ì£ºÎÞ
 236          ´´½¨ÈÕÆÚ£º2020-12-24
 237          ÐÞ¸Ä¼ÇÂ¼£º
 238          -------------------------------------------------------*/
 239          void data_save(void){
 240   1              u16 i;
C51 COMPILER V9.59.0.0   MAIN                                                              12/30/2020 22:25:38 PAGE 5   

 241   1              if(proj_count<=256){                                                                                    //Èç¹û×Ü¼ÆÊýÐ¡ÓÚ256£¬ËµÃ÷ÊÇµÚÒ»°üÊý¾Ý¡£
 242   2                      eeprom_write(APP_JMP_ADDR  ,eeprom_buf[1]);                                     //µÚÒ»°üÊý¾ÝÍ¨³£¶¼°üº¬ÁËÌø×ªµØÖ·£¬
 243   2                      eeprom_write(APP_JMP_ADDR+1,eeprom_buf[2]);                                     //°ÑÌø×ªµØÖ·±£´æÆðÀ´¡£
 244   2                      for(i=3;i<proj_count;i++){                                                                      //È»ºóÐ´ÈëÊ£ÏÂµÄÊý¾Ý¡£
 245   3                              eeprom_write(i,eeprom_buf[i]);
 246   3                      }
 247   2              }else{                                                                                                                  //Èç¹û²»ÊÇµÚÒ»°üÊý¾Ý£¬
 248   2                      for(i=0;i<data_count;i++){                                                                      //ÄÇ¾ÍÖ±½Ó±£´æµ½flash¾ÍÐÐÁË¡£
 249   3                              eeprom_write(i+(proj_count-data_count),eeprom_buf[i]);
 250   3                      }
 251   2              }
 252   1      }
 253          
 254          void main(void){
 255   1              u16 i;          //16Î»ÁÙÊ±±äÁ¿¡£
 256   1              u8 timeout;     //Ê±¼ä³¬Ê±¼ÆÊýÆ÷¡£
 257   1              IAP_TPS=24;     //STC8GºÍSTC8HµÄÉèÖÃ£¬Ä¬ÈÏ24MHz¡£
 258   1      /*------------------------------------------BootLoader³õÊ¼»¯-------------------------------*/
 259   1              if(read_boot_flag&GET_ENABLE){                                                                                  //ÅÐ¶ÏÊÇ²»ÊÇµÚÒ»´ÎÔËÐÐbootloader£¬                                      
 260   2                      eeprom_write(BOOT_STATUS,               SET_ENABLE);                                            //ÊÇµÄ»°¾ÍÖÃÎ»Ê¹ÄÜ±êÖ¾¡£
 261   2                      eeprom_write( APP_JMP_ADDR,             (*(unsigned char code *)(0x0001)));     //³õÊ¼»¯APPµÄÌø×ªµØÖ·¡£
 262   2                      eeprom_write( APP_JMP_ADDR+1,   (*(unsigned char code *)(0x0002)));     //
 263   2                      eeprom_write(BOOT_JMP_ADDR,             (*(unsigned char code *)(0x0001)));     //³õÊ¼»¯BOOTµÄÌø×ªµØÖ·¡£
 264   2                      eeprom_write(BOOT_JMP_ADDR+1,   (*(unsigned char code *)(0x0002)));     //
 265   2                      eeprom_write(BOOT_STATUS,               SET_DONE);                                                      //ÖÃÎ»³õÊ¼»¯Íê±Ï±êÖ¾¡£
 266   2              }                                                                                                                                               //ÖÁ´ËBootLoader³õÊ¼»¯Íê³É¡£
 267   1      /*------------------------------------------APP¼ì²â---------------------------------------*/    
 268   1              jmp_app=(u32)read_boot_addr;                            //Ä¬ÈÏ°ÑBootLoaderµÄµØÖ·¸øAPPµØÖ·¡£·ÀÖ¹ÂÒÌø×ª¡£
 269   1              if((read_app__flag&PD_APP__OK)==APP__OK){       //ÅÐ¶Ï³ÌÐòÊÇ·ñºÏ·¨¡£
 270   2                      jmp_app=(u32)read_app__addr;                    //³ÌÐòºÏ·¨£¬Ôò½«APPÌø×ªµØÖ·¸øÌø×ªº¯Êý¡£
 271   2                      if(BOOT_PIN==BOOT_RUN_APP){jmp_app();}  //BOOT½ÅÊÇÄÜÌø×ªµ½APPµÄµçÆ½¾ÍÌø×ªµ½APP¡£
 272   2              }
 273   1      /*-----------------------------------BootLoader½çÃæ--------------------------------------*/
 274   1              hard_init();                                    //³õÊ¼»¯´®¿ÚºÍ¶¨Ê±Æ÷¡£
 275   1              send_string("[Boot](0)\r\n");   //ÌáÊ¾½øÈëÁËBOOT×´Ì¬¡£
 276   1              while(!RI);                                             //µÈ´ý½ÓÊÕ½âËøÂë¡£
 277   1              RI=0;                                                   //ÖÃÁã½ÓÊÕ±êÖ¾Î»¡£
 278   1              if(SBUF!='!'){                                  //Èç¹û²»ÊÇ½âËøÂë£¬ËµÃ÷´®¿Ú´ËÊ±ÊÇÂÒ´«Êý¾ÝµÄ¡£
 279   2                      send_string("[Lock](1)\r\n");//ÌáÊ¾ÒªËø¶¨µ¥Æ¬»ú¡£
 280   2                      while(1);                                       //ËÀÑ­»·£¬Ëø¶¨µ¥Æ¬»ú²»ÄÜ¼ÌÐøÏÂÔØ¡£
 281   2              }
 282   1      /*--------------------------------------ÏÂÔØ½çÃæ------------------------------------------*/
 283   1              send_string("[Erase](2)\r\n");                                                                  //ÌáÊ¾¿ªÊ¼²Á³ý¡£
 284   1              eeprom_erase(0x0000);                                                                                   //ÏÈ²ÁµÚÒ»ÉÈÇø¡£
 285   1              eeprom_write(0x0000,0x02);                                                                              //Á¢¿ÌÐ´ÈëÌø×ªÖ¸Áî¡£
 286   1              eeprom_write(0x0001,(*(unsigned char code *)(BOOT_JMP_ADDR)));  //È¡³öBOOTµÄÌø×ªµØÖ·¸ß8Î»£¬Ð´Èëµ½Ö¸¶¨µØÖ·Ö
             -Ð¡£
 287   1              eeprom_write(0x0002,(*(unsigned char code *)(BOOT_JMP_ADDR+1)));//È¡µØÖ·µÍ8Î»£¬·Ö³ÉÁ½¸öµ¥×Ö½ÚÐ´º¯Êý£¬¿ÉÒÔ
             -¼Ó¿ìÔËÐÐËÙ¶È¡£
 288   1              eeprom_write_boot_area(APP_START,INIT_MASK,APP_MAX);                    //³õÊ¼»¯APP×´Ì¬Çø¡£
 289   1              eeprom_write(APP_STATUS,SET_ENABLE);                                                    //Ð´ÈëAPPÊ¹ÄÜ±êÖ¾Î»¡£
 290   1              for(i=512;i<FLASH_SIZE;i+=512){                                                                 //²Á³ýºóÃæµÄÉÈÇø¡£
 291   2                      eeprom_erase(i);
 292   2              }
 293   1              data_count=0;                           //ÇåÁãµ¥°üÊý¾Ý¼ÆÊýÆ÷¡£
 294   1              proj_count=0;                           //ÇåÁã×ÜÌåÊý¾Ý¼ÆÊýÆ÷¡£
 295   1              send_string("[Start](3)");      //ÌáÊ¾¿ªÊ¼ÏÂÔØ¡£
 296   1              TR0=1;                                          //´ò¿ª¶¨Ê±Æ÷£¬¼´ÆôÓÃ³¬Ê±ÅÐ¶Ï¡£
 297   1              timeout=250;                            //µÚÒ»´Î³¬Ê±Ê±¼äÎª250*20ms=5000ms=5s£¬ÉÏÎ»»úµã»÷²Ù×÷ÐèÒªÊ±¼ä£¬µÚÒ»´Î³¬Ê±ÅÐ¶ÏÒª¾ÃÒ»Ð©¡£
 298   1              while(1){                                                                                                                       //ÔÚÑ­»·Àï½ÓÊÕÊý¾Ý¡£
 299   2                      while(!RI){                                                                                                             //µÈ´ý´®¿ÚÀ´Êý¾Ý¡£
 300   3                              if(TF0){                                                                                                        //Ã¿µ±¶¨Ê±Æ÷Òç³öÊ±£¬
C51 COMPILER V9.59.0.0   MAIN                                                              12/30/2020 22:25:38 PAGE 6   

 301   4                                      TF0=0;                                                                                                  //ÇåÁã±êÖ¾Î»¡£
 302   4                                      timeout--;                                                                                              //³¬Ê±Ê±¼ä-1¡£
 303   4                                      if(timeout==0){                                                                                 //µ±Ê±¼ä¼õµ½0µÄÊ±ºò£¬ËµÃ÷³¬Ê±ÁË¡£
 304   5                                              TR0=0;                                                                                          //¹Ø±Õ¶¨Ê±Æ÷¡£
 305   5                                              if(proj_count){                                                                         //Èç¹ûÆÚ¼ä½ÓÊÕÁËÊý¾Ý£¬
 306   6                                                      send_string("\r\n[Get ");                                               //ÏÔÊ¾½ÓÊÕÁË¶àÉÙÊý¾Ý¡£
 307   6                                                      send_num(proj_count);
 308   6                                                      send_string(" Byte](4)\r\n");                                   //µ¥Î»ÊÇ×Ö½Ú¡£
 309   6                                                      data_save();                                                                    //±£´æÕâÐ©Êý¾Ý£¬ÔÚÕâÀï±£´æµÄÍ¨³£ÊÇ×îºóÒ»°üµÄÊý¾Ý¡£
 310   6                                                      eeprom_write(APP_SIZE,  (u8)(proj_count>>8));   //¶ÁÈ¡APPµÄ´óÐ¡¸ß8Î»£¬Ð´Èëµ½Ö¸¶¨µØÖ·ÖÐ¡£
 311   6                                                      eeprom_write(APP_SIZE+1,(u8)(proj_count));              //¶ÁÈ¡APPµÄ´óÐ¡µÍ8Î»£¬·Ö³ÉÁ½¸öµ¥×Ö½ÚÐ´º¯Êý£¬¿ÉÒÔ¼Ó¿ìÔËÐÐ
             -ËÙ¶È¡£
 312   6                                                      eeprom_write(APP_STATUS,SET_DONE);                              //°²×°Íê³É£¬Ð´Íê³É±êÖ¾Î»¡£
 313   6                                                      jmp_app=(u32)read_app__addr;                                    //½«APPÌø×ªµØÖ·¸øÌø×ªº¯Êý¡£
 314   6                                              }else{                                                                                          //Èç¹ûÆÚ¼äÃ»ÓÐ½ÓÊÕµ½Êý¾Ý£¬
 315   6                                                      send_string("\r\n[Time Out](5)\r\n");                   //ÏÔÊ¾³¬Ê±¡£
 316   6                                                      jmp_app=(u32)read_boot_addr;                                    //½«BOOTµÄÌø×ªµØÖ·¸øÌø×ªº¯Êý¡£
 317   6                                              }
 318   5                                              jmp_app();                                                                                      //ÏÂÔØ½ø³ÌÍê±Ï£¬Ìø×ª¡£
 319   5                                      }
 320   4                              }
 321   3                      }
 322   2                      TF0=0;                                                                          //Èç¹û½ÓÊÕµ½´®¿ÚÊý¾Ý£¬Ò²ÒªÇåÁã¶¨Ê±Æ÷±êÖ¾Î»¡£
 323   2                      RI=0;                                                                           //Í¬Ê±ÇåÁã½ÓÊÕ±êÖ¾Î»¡£
 324   2                      eeprom_buf[data_count++]=SBUF;                          //½«½ÓÊÕµÄÊý¾Ý±£´æÏÂÀ´¡£
 325   2                      proj_count++;                                                           //Í³¼ÆÄ¿Ç°ÒÑ½ÓÊÕµÄÊý¾Ý´óÐ¡¡£
 326   2                      if(data_count==256){                                            //sscom5ÉÏÎ»»úÊÇ256×Ö½Ú·ÖÒ»°ü£¬ËùÒÔÃ¿ÊÕµ½256×Ö½ÚµÄÊ±ºò£¬
 327   3                              data_save();                                                    //¾ÍÒª°ÑÊý¾Ý±£´æÏÂÀ´¡£
 328   3                              data_count=0;                                                   //Í¬Ê±ÇåÁãÊý¾ÝÍ³¼Æ±êÖ¾Î»¡£
 329   3                      }
 330   2                      if(proj_count>FLASH_SIZE){                                      //Èç¹û½ÓÊÕµ½µÄ´óÐ¡´óÓÚ×ÜµÄ¿Õ¼ä£¬
 331   3                              send_string("\r\n[Overflow](6)\r\n");   //ÌáÊ¾ÈÝÁ¿Òç³ö¡£
 332   3                              while(1);                                                               //ËÀÑ­»·£¬Ëø¶¨µ¥Æ¬»ú¡£
 333   3                      }
 334   2                      timeout=50;                                                                     //³¬Ê±Ê±¼äÎª50*20ms=1000ms=1s
 335   2              }     
 336   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    977    ----
   CONSTANT SIZE    =    110    ----
   XDATA SIZE       =    512    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
